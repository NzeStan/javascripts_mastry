# Module 05 - Lesson 4: Fetch API & HTTP Requests

## What is the Fetch API?

**Fetch API** is the modern way to make HTTP requests in JavaScript. It replaces the old XMLHttpRequest!

**Features:**
- ‚úÖ Promise-based (works with async/await!)
- ‚úÖ Clean, simple syntax
- ‚úÖ Built into modern browsers
- ‚úÖ Works with JSON easily

---

## Basic Fetch Syntax

```javascript
fetch(url, options)
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error(error));
```

**Parameters:**
- `url`: The endpoint to fetch from
- `options`: Request configuration (optional)

---

## Simple GET Request

### Basic Example

```javascript
// Fetch data from an API
fetch("https://jsonplaceholder.typicode.com/users/1")
    .then(response => response.json())
    .then(user => {
        console.log("User:", user);
    })
    .catch(error => {
        console.error("Error:", error);
    });
```

### With async/await

```javascript
async function getUser(id) {
    try {
        const response = await fetch(`https://jsonplaceholder.typicode.com/users/${id}`);
        const user = await response.json();
        console.log("User:", user);
        return user;
    } catch (error) {
        console.error("Error:", error);
    }
}

getUser(1);
```

---

## Understanding the Response

### Response Object

```javascript
fetch("https://jsonplaceholder.typicode.com/users/1")
    .then(response => {
        console.log("Status:", response.status);       // 200
        console.log("OK?:", response.ok);              // true
        console.log("Status Text:", response.statusText); // "OK"
        console.log("Headers:", response.headers);
        
        return response.json();
    })
    .then(data => console.log("Data:", data));
```

### Response Methods

```javascript
// response.json() - Parse as JSON
const jsonData = await response.json();

// response.text() - Get as plain text
const textData = await response.text();

// response.blob() - Get as binary blob
const imageBlob = await response.blob();

// response.arrayBuffer() - Get as array buffer
const buffer = await response.arrayBuffer();
```

---

## Checking for Errors

**Important:** Fetch only rejects on network errors, NOT HTTP errors!

### Manual Error Checking

```javascript
async function fetchWithError(url) {
    try {
        const response = await fetch(url);
        
        // Check if response is OK (status 200-299)
        if (!response.ok) {
            throw new Error(`HTTP Error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        return data;
    } catch (error) {
        console.error("Fetch error:", error);
        throw error;
    }
}

// Usage
fetchWithError("https://jsonplaceholder.typicode.com/users/1")
    .then(data => console.log("Data:", data))
    .catch(error => console.error("Failed:", error));
```

### Helper Function

```javascript
async function safeFetch(url, options = {}) {
    try {
        const response = await fetch(url, options);
        
        if (!response.ok) {
            const error = new Error(`HTTP ${response.status}: ${response.statusText}`);
            error.response = response;
            error.status = response.status;
            throw error;
        }
        
        return await response.json();
    } catch (error) {
        console.error("Fetch failed:", error);
        throw error;
    }
}
```

---

## Request Methods (GET, POST, PUT, DELETE)

### GET Request (Default)

```javascript
// Get all users
fetch("https://jsonplaceholder.typicode.com/users")
    .then(res => res.json())
    .then(users => console.log("Users:", users));

// Get specific user
fetch("https://jsonplaceholder.typicode.com/users/1")
    .then(res => res.json())
    .then(user => console.log("User:", user));
```

### POST Request (Create)

```javascript
async function createPost(post) {
    const response = await fetch("https://jsonplaceholder.typicode.com/posts", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(post)
    });
    
    if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
    }
    
    const data = await response.json();
    return data;
}

// Usage
createPost({
    title: "My New Post",
    body: "This is the content",
    userId: 1
})
.then(post => console.log("Created:", post))
.catch(error => console.error("Error:", error));
```

### PUT Request (Update/Replace)

```javascript
async function updatePost(id, post) {
    const response = await fetch(`https://jsonplaceholder.typicode.com/posts/${id}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(post)
    });
    
    return await response.json();
}

// Usage
updatePost(1, {
    id: 1,
    title: "Updated Title",
    body: "Updated content",
    userId: 1
})
.then(post => console.log("Updated:", post));
```

### PATCH Request (Partial Update)

```javascript
async function patchPost(id, updates) {
    const response = await fetch(`https://jsonplaceholder.typicode.com/posts/${id}`, {
        method: "PATCH",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(updates)
    });
    
    return await response.json();
}

// Usage - only update title
patchPost(1, { title: "New Title" })
    .then(post => console.log("Patched:", post));
```

### DELETE Request

```javascript
async function deletePost(id) {
    const response = await fetch(`https://jsonplaceholder.typicode.com/posts/${id}`, {
        method: "DELETE"
    });
    
    if (!response.ok) {
        throw new Error(`Failed to delete: ${response.status}`);
    }
    
    console.log("Post deleted!");
    return true;
}

// Usage
deletePost(1)
    .then(() => console.log("Deleted successfully"))
    .catch(error => console.error("Error:", error));
```

---

## Working with Headers

### Reading Response Headers

```javascript
fetch("https://jsonplaceholder.typicode.com/users")
    .then(response => {
        // Get specific header
        const contentType = response.headers.get("content-type");
        console.log("Content-Type:", contentType);
        
        // Check if header exists
        const hasAuth = response.headers.has("authorization");
        console.log("Has Auth:", hasAuth);
        
        // Iterate over all headers
        for (let [key, value] of response.headers) {
            console.log(`${key}: ${value}`);
        }
        
        return response.json();
    });
```

### Setting Request Headers

```javascript
async function fetchWithAuth(url, token) {
    const response = await fetch(url, {
        headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json",
            "X-Custom-Header": "MyValue"
        }
    });
    
    return await response.json();
}

// Usage
fetchWithAuth("/api/protected", "my-token-123")
    .then(data => console.log("Protected data:", data));
```

---

## Query Parameters

### Manual URL Building

```javascript
const baseUrl = "https://jsonplaceholder.typicode.com/posts";
const userId = 1;
const limit = 5;

const url = `${baseUrl}?userId=${userId}&_limit=${limit}`;

fetch(url)
    .then(res => res.json())
    .then(posts => console.log("Filtered posts:", posts));
```

### Using URLSearchParams

```javascript
function buildUrl(base, params) {
    const url = new URL(base);
    
    Object.keys(params).forEach(key => {
        url.searchParams.append(key, params[key]);
    });
    
    return url.toString();
}

// Usage
const url = buildUrl("https://jsonplaceholder.typicode.com/posts", {
    userId: 1,
    _limit: 5,
    _sort: "title"
});

fetch(url)
    .then(res => res.json())
    .then(posts => console.log("Posts:", posts));
```

---

## Fetch Options

### Complete Options Object

```javascript
fetch(url, {
    method: "POST",              // GET, POST, PUT, PATCH, DELETE
    headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer token"
    },
    body: JSON.stringify(data),  // Must be string, FormData, or Blob
    mode: "cors",                // cors, no-cors, same-origin
    credentials: "same-origin",  // include, same-origin, omit
    cache: "default",            // default, no-cache, reload, force-cache
    redirect: "follow",          // follow, error, manual
    referrer: "client",          // client, no-referrer, URL
    signal: abortController.signal // For aborting requests
});
```

---

## Aborting Requests

### Using AbortController

```javascript
const controller = new AbortController();
const signal = controller.signal;

// Start fetch
fetch("https://jsonplaceholder.typicode.com/users", { signal })
    .then(res => res.json())
    .then(data => console.log("Data:", data))
    .catch(error => {
        if (error.name === "AbortError") {
            console.log("Fetch aborted!");
        } else {
            console.error("Error:", error);
        }
    });

// Abort after 1 second
setTimeout(() => {
    controller.abort();
}, 1000);
```

### Timeout Helper

```javascript
function fetchWithTimeout(url, timeout = 5000) {
    const controller = new AbortController();
    
    const timeoutId = setTimeout(() => {
        controller.abort();
    }, timeout);
    
    return fetch(url, { signal: controller.signal })
        .then(response => {
            clearTimeout(timeoutId);
            return response;
        })
        .catch(error => {
            clearTimeout(timeoutId);
            throw error;
        });
}

// Usage
fetchWithTimeout("https://jsonplaceholder.typicode.com/users", 3000)
    .then(res => res.json())
    .then(data => console.log("Data:", data))
    .catch(error => console.error("Timeout or error:", error));
```

---

## Real-World Examples

### Example 1: User Search

```javascript
async function searchUsers(query) {
    try {
        const response = await fetch(`https://api.github.com/search/users?q=${query}`);
        
        if (!response.ok) {
            throw new Error(`Search failed: ${response.status}`);
        }
        
        const data = await response.json();
        return data.items;
    } catch (error) {
        console.error("Search error:", error);
        return [];
    }
}

// Usage
searchUsers("ifeanyi")
    .then(users => {
        users.forEach(user => {
            console.log(`${user.login} - ${user.html_url}`);
        });
    });
```

### Example 2: Form Submission

```javascript
async function submitForm(formData) {
    try {
        const response = await fetch("/api/submit", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "Submission failed");
        }
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error("Form submission error:", error);
        throw error;
    }
}

// Usage
const form = {
    name: "Ifeanyi Stanley",
    email: "ifeanyi@example.com",
    message: "Hello!"
};

submitForm(form)
    .then(result => console.log("Success:", result))
    .catch(error => alert("Error: " + error.message));
```

### Example 3: File Upload

```javascript
async function uploadFile(file) {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("name", file.name);
    
    try {
        const response = await fetch("/api/upload", {
            method: "POST",
            body: formData  // Don't set Content-Type header!
        });
        
        if (!response.ok) {
            throw new Error("Upload failed");
        }
        
        const result = await response.json();
        return result;
    } catch (error) {
        console.error("Upload error:", error);
        throw error;
    }
}

// Usage with file input
const fileInput = document.querySelector('input[type="file"]');
fileInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (file) {
        try {
            const result = await uploadFile(file);
            console.log("Uploaded:", result);
        } catch (error) {
            alert("Upload failed: " + error.message);
        }
    }
});
```

### Example 4: Pagination

```javascript
async function fetchPage(page = 1, limit = 10) {
    const url = `https://jsonplaceholder.typicode.com/posts?_page=${page}&_limit=${limit}`;
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        
        // Get total count from headers
        const total = response.headers.get("x-total-count");
        
        return {
            data,
            page,
            limit,
            total: parseInt(total),
            totalPages: Math.ceil(total / limit)
        };
    } catch (error) {
        console.error("Pagination error:", error);
        throw error;
    }
}

// Usage
async function loadAllPages() {
    let page = 1;
    let allData = [];
    
    while (true) {
        const result = await fetchPage(page, 10);
        allData.push(...result.data);
        
        console.log(`Loaded page ${page}/${result.totalPages}`);
        
        if (page >= result.totalPages) {
            break;
        }
        
        page++;
    }
    
    return allData;
}

loadAllPages().then(data => {
    console.log("All data loaded:", data.length, "items");
});
```

### Example 5: Concurrent Requests

```javascript
async function fetchMultipleUsers(ids) {
    const promises = ids.map(id => 
        fetch(`https://jsonplaceholder.typicode.com/users/${id}`)
            .then(res => res.json())
    );
    
    try {
        const users = await Promise.all(promises);
        return users;
    } catch (error) {
        console.error("Failed to fetch users:", error);
        return [];
    }
}

// Usage
fetchMultipleUsers([1, 2, 3, 4, 5])
    .then(users => {
        console.log("Fetched users:", users);
    });
```

---

## CORS (Cross-Origin Resource Sharing)

### What is CORS?

CORS is a security feature that restricts web pages from making requests to a different domain.

```javascript
// This might fail with CORS error
fetch("https://different-domain.com/api/data")
    .then(res => res.json())
    .catch(error => {
        console.error("CORS error:", error);
        // Error: No 'Access-Control-Allow-Origin' header
    });
```

### Solutions:

1. **Server must allow CORS** (backend sets headers)
2. **Use a proxy** (development only)
3. **Use JSONP** (outdated)
4. **Make request from backend** (recommended for production)

### CORS Mode Options

```javascript
// Default - requires CORS headers
fetch(url, { mode: "cors" })

// No CORS check (limited response access)
fetch(url, { mode: "no-cors" })

// Same origin only
fetch(url, { mode: "same-origin" })
```

---

## Free Public APIs for Practice

### JSONPlaceholder (Fake REST API)

```javascript
// Perfect for testing!
const BASE_URL = "https://jsonplaceholder.typicode.com";

// Get posts
fetch(`${BASE_URL}/posts`)
    .then(res => res.json())
    .then(posts => console.log(posts));

// Get users
fetch(`${BASE_URL}/users`)
    .then(res => res.json())
    .then(users => console.log(users));
```

### Other Free APIs

```javascript
// Random user data
fetch("https://randomuser.me/api/")
    .then(res => res.json())
    .then(data => console.log(data.results[0]));

// Random jokes
fetch("https://official-joke-api.appspot.com/random_joke")
    .then(res => res.json())
    .then(joke => console.log(joke.setup, joke.punchline));

// Dog images
fetch("https://dog.ceo/api/breeds/image/random")
    .then(res => res.json())
    .then(data => console.log(data.message));

// GitHub user
fetch("https://api.github.com/users/github")
    .then(res => res.json())
    .then(user => console.log(user));
```

---

## Practice Exercises

Create `05-async-javascript/exercises/fetch-practice.html`:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch API Practice</title>
</head>
<body>
    <h1>Fetch API Practice</h1>
    <button id="fetchUsers">Fetch Users</button>
    <button id="createPost">Create Post</button>
    <div id="output"></div>

    <script>
        const output = document.getElementById("output");

        // Exercise 1: Basic fetch
        document.getElementById("fetchUsers").addEventListener("click", async () => {
            try {
                const response = await fetch("https://jsonplaceholder.typicode.com/users");
                const users = await response.json();
                
                output.innerHTML = "<h2>Users:</h2>";
                users.slice(0, 5).forEach(user => {
                    output.innerHTML += `<p>${user.name} - ${user.email}</p>`;
                });
            } catch (error) {
                console.error("Error:", error);
            }
        });

        // Exercise 2: POST request
        document.getElementById("createPost").addEventListener("click", async () => {
            try {
                const response = await fetch("https://jsonplaceholder.typicode.com/posts", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        title: "My Post",
                        body: "This is my post content",
                        userId: 1
                    })
                });
                
                const post = await response.json();
                output.innerHTML = "<h2>Created Post:</h2>";
                output.innerHTML += `<p><strong>${post.title}</strong></p>`;
                output.innerHTML += `<p>${post.body}</p>`;
                output.innerHTML += `<p>ID: ${post.id}</p>`;
            } catch (error) {
                console.error("Error:", error);
            }
        });

        // Exercise 3: Error handling
        async function fetchWithError() {
            try {
                const response = await fetch("https://jsonplaceholder.typicode.com/invalid");
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Data:", data);
            } catch (error) {
                console.error("Caught error:", error.message);
            }
        }

        // Exercise 4: Multiple requests
        async function fetchMultiple() {
            const [users, posts, comments] = await Promise.all([
                fetch("https://jsonplaceholder.typicode.com/users").then(r => r.json()),
                fetch("https://jsonplaceholder.typicode.com/posts").then(r => r.json()),
                fetch("https://jsonplaceholder.typicode.com/comments").then(r => r.json())
            ]);
            
            console.log("Users:", users.length);
            console.log("Posts:", posts.length);
            console.log("Comments:", comments.length);
        }
        
        fetchMultiple();
    </script>
</body>
</html>
```

---

## Key Takeaways ‚úì

- [ ] Fetch returns a Promise
- [ ] Must call `.json()` to parse JSON response
- [ ] Check `response.ok` for HTTP errors
- [ ] Default method is GET
- [ ] POST/PUT require body and Content-Type header
- [ ] Use AbortController to cancel requests
- [ ] CORS restrictions apply to cross-origin requests
- [ ] Fetch only rejects on network errors

---

## What's Next?

You've mastered async JavaScript! Now it's time to **build a real app**!

**Project:** Weather App that fetches real weather data from an API!

**Ready?** Check out `project-weather-app/` folder! üå§Ô∏è